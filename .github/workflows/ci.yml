name: CI

on:
  pull_request:
    branches: [stage]
  push:
    branches: [stage]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node: [18, 20]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.6

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Unit & component tests (web)
        run: pnpm --filter web test -- --reporter=basic --coverage --reporter=json --outputFile=apps/web/coverage/vitest-report.json

      - name: Firestore rules tests
        env:
          FIRESTORE_EMULATOR_PORT: 8085
          FIRESTORE_EMULATOR_HOST: 127.0.0.1:8085
        run: pnpm dlx firebase-tools@13.15.0 emulators:exec --only firestore --project cleo-aura-fitness-test "pnpm exec vitest run firestore.test.ts --reporter=basic"

      - name: Security audit (production deps)
        run: pnpm audit:ci

      - name: Publish test & coverage summary
        if: always()
        run: |
          node -e "const fs=require('fs'); const summaryPath='apps/web/coverage/vitest-report.json'; const covPath='apps/web/coverage/coverage-summary.json'; let tests='(no test report found)'; try { const data=JSON.parse(fs.readFileSync(summaryPath,'utf8')); const totals=data?.testResults?.reduce((acc,suite)=>{acc.total+=(suite.numFailingTests+suite.numPassingTests+suite.numPendingTests+suite.numTodoTests); acc.passed+=suite.numPassingTests; acc.failed+=suite.numFailingTests; acc.skipped+=(suite.numPendingTests+suite.numTodoTests); return acc;},{total:0,passed:0,failed:0,skipped:0}); tests=`Tests: ${totals.passed}/${totals.total} passed, ${totals.failed} failed, ${totals.skipped} skipped`; } catch(e) { tests='Tests: summary not generated'; } let cov='Coverage: summary not generated'; try { const covData=JSON.parse(fs.readFileSync(covPath,'utf8')).total; cov=`Coverage (web): Lines ${covData.lines.pct}% (${covData.lines.covered}/${covData.lines.total}), Branches ${covData.branches.pct}%, Functions ${covData.functions.pct}%, Statements ${covData.statements.pct}%`; } catch(e) {} const out=`## Web Tests & Coverage\n${tests}\n${cov}\n`; fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, out);"

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: web-coverage
          path: |
            apps/web/coverage/lcov.info
            apps/web/coverage/coverage-summary.json
            apps/web/coverage/vitest-report.json
          if-no-files-found: warn

      - name: Upload to Codecov
        if: always() && matrix.node == 20 && secrets.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: apps/web/coverage/lcov.info
          flags: web
          fail_ci_if_error: false

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Dependency review
        uses: actions/dependency-review-action@v4
