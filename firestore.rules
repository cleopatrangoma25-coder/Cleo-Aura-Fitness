rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isTraineeOwner(traineeId) {
      return isSignedIn() && request.auth.uid == traineeId;
    }

    function currentUserRole() {
      return isSignedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
          ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
          : null;
    }

    function isTraineeUser() {
      return currentUserRole() == 'trainee';
    }

    function isProfessionalUser() {
      return currentUserRole() in ['trainer', 'nutritionist', 'counsellor'];
    }

    function hasActiveGrant(traineeId) {
      return isSignedIn()
        && exists(/databases/$(database)/documents/trainees/$(traineeId)/grants/$(request.auth.uid))
        && exists(/databases/$(database)/documents/trainees/$(traineeId)/teamMembers/$(request.auth.uid))
        && get(/databases/$(database)/documents/trainees/$(traineeId)/grants/$(request.auth.uid)).data.active == true
        && get(/databases/$(database)/documents/trainees/$(traineeId)/teamMembers/$(request.auth.uid)).data.status == 'active';
    }

    function hasModuleGrant(traineeId, module) {
      return hasActiveGrant(traineeId)
        && get(/databases/$(database)/documents/trainees/$(traineeId)/grants/$(request.auth.uid)).data.modules[module] == true;
    }

    function inviteAcceptedForSelf(traineeId, inviteCode) {
      return inviteCode is string
        && exists(/databases/$(database)/documents/trainees/$(traineeId)/invites/$(inviteCode))
        && get(/databases/$(database)/documents/trainees/$(traineeId)/invites/$(inviteCode)).data.status == 'accepted'
        && get(/databases/$(database)/documents/trainees/$(traineeId)/invites/$(inviteCode)).data.acceptedByUid == request.auth.uid
        && get(/databases/$(database)/documents/trainees/$(traineeId)/invites/$(inviteCode)).data.traineeId == traineeId
        && get(/databases/$(database)/documents/trainees/$(traineeId)/invites/$(inviteCode)).data.role == currentUserRole();
    }

    function allModulesDisabled(modules) {
      return modules.workouts == false
        && modules.recovery == false
        && modules.nutrition == false
        && modules.wellbeing == false
        && modules.progress == false;
    }

    match /users/{userId} {
      allow read, create, update: if isOwner(userId);
      allow delete: if false;
    }

    match /trainees/{traineeId} {
      allow read: if isTraineeOwner(traineeId) || hasActiveGrant(traineeId);
      allow create, update: if isTraineeOwner(traineeId) && isTraineeUser();
      allow delete: if false;

      match /invites/{inviteCode} {
        allow read: if isTraineeOwner(traineeId) || (isSignedIn() && resource.data.status == 'pending');
        allow create, delete: if isTraineeOwner(traineeId);
        allow update: if isTraineeOwner(traineeId)
          || (
            isProfessionalUser()
            && resource.data.status == 'pending'
            && request.resource.data.status == 'accepted'
            && request.resource.data.acceptedByUid == request.auth.uid
            && request.resource.data.traineeId == traineeId
            && request.resource.data.role == currentUserRole()
          );
      }

      match /teamMembers/{memberUid} {
        allow read: if isTraineeOwner(traineeId) || isOwner(memberUid);
        allow create: if isTraineeOwner(traineeId)
          || (
            isProfessionalUser()
            && isOwner(memberUid)
            && request.resource.data.uid == request.auth.uid
            && request.resource.data.role == currentUserRole()
            && inviteAcceptedForSelf(traineeId, request.resource.data.inviteCode)
          );
        allow update, delete: if isTraineeOwner(traineeId);
      }

      match /grants/{memberUid} {
        allow read: if isTraineeOwner(traineeId) || isOwner(memberUid);
        allow create: if isTraineeOwner(traineeId)
          || (
            isProfessionalUser()
            && isOwner(memberUid)
            && request.resource.data.memberUid == request.auth.uid
            && request.resource.data.role == currentUserRole()
            && request.resource.data.active == true
            && allModulesDisabled(request.resource.data.modules)
            && inviteAcceptedForSelf(traineeId, request.resource.data.inviteCode)
          );
        allow update, delete: if isTraineeOwner(traineeId);
      }

      match /workouts/{workoutId} {
        allow read: if isTraineeOwner(traineeId) || hasModuleGrant(traineeId, 'workouts');
        allow write: if isTraineeOwner(traineeId) && isTraineeUser();
      }

      match /recovery/{recoveryId} {
        allow read: if isTraineeOwner(traineeId) || hasModuleGrant(traineeId, 'recovery');
        allow write: if isTraineeOwner(traineeId) && isTraineeUser();
      }

      match /nutritionDays/{dayId} {
        allow read: if isTraineeOwner(traineeId) || hasModuleGrant(traineeId, 'nutrition');
        allow write: if isTraineeOwner(traineeId) && isTraineeUser();
      }

      match /wellbeingDays/{dayId} {
        allow read: if isTraineeOwner(traineeId) || hasModuleGrant(traineeId, 'wellbeing');
        allow write: if isTraineeOwner(traineeId) && isTraineeUser();
      }

      match /progressMeasurements/{measurementId} {
        allow read: if isTraineeOwner(traineeId) || hasModuleGrant(traineeId, 'progress');
        allow write: if isTraineeOwner(traineeId) && isTraineeUser();
      }

      match /{subcollection}/{document=**} {
        allow read: if isTraineeOwner(traineeId);
        allow write: if isTraineeOwner(traineeId) && isTraineeUser();
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
